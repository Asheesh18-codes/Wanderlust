<% layout("/layouts/boilerplate.ejs") %>

<script>
  let mapToken = '<%= process.env.MAP_TOKEN %>'; 
  const listing = <%- JSON.stringify(listing) %>;
</script>

<style>
.listing-header {
  margin-bottom: 24px;
}

.listing-title {
  font-size: 26px;
  font-weight: 600;
  color: var(--airbnb-dark);
  margin-bottom: 8px;
}

.listing-subtitle {
  font-size: 14px;
  color: var(--airbnb-gray);
  margin-bottom: 16px;
}

.action-buttons {
  display: flex;
  gap: 16px;
  margin-bottom: 24px;
}

.btn-airbnb {
  background: var(--airbnb-red);
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.btn-airbnb:hover {
  background: var(--airbnb-red-dark);
  color: white;
}

.btn-outline-airbnb {
  background: white;
  border: 1px solid var(--airbnb-dark);
  color: var(--airbnb-dark);
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.btn-outline-airbnb:hover {
  background: var(--airbnb-dark);
  color: white;
}

.image-gallery {
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 32px;
  height: 400px;
}

.main-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.listing-details {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 80px;
  margin-bottom: 48px;
}

.listing-info h2 {
  font-size: 22px;
  font-weight: 600;
  margin-bottom: 8px;
}

.host-info {
  color: var(--airbnb-gray);
  font-size: 16px;
  margin-bottom: 24px;
}

.amenities {
  padding: 32px 0;
  border-top: 1px solid #EBEBEB;
  border-bottom: 1px solid #EBEBEB;
}

.booking-card {
  background: white;
  border: 1px solid #DDDDDD;
  border-radius: 12px;
  padding: 24px;
  box-shadow: var(--shadow-medium);
  position: sticky;
  top: 120px;
  height: fit-content;
}

.price-display {
  font-size: 22px;
  font-weight: 600;
  margin-bottom: 16px;
}

.reviews-section {
  border-top: 1px solid #EBEBEB;
  padding-top: 32px;
  margin-top: 32px;
}

@media (max-width: 768px) {
  .listing-details {
    grid-template-columns: 1fr;
    gap: 32px;
  }
  
  .booking-card {
    position: relative;
    top: 0;
  }
}
</style>

<body>
  <div class="container" style="max-width: 1120px;">
    <!-- Header -->
    <div class="listing-header">
      <h1 class="listing-title"><%= listing.title %></h1>
      <div class="listing-subtitle">
        <i class="fa-solid fa-location-dot"></i> 
        <%= listing.location %>, <%= listing.country %>
      </div>
      
      <% if(currentUser && currentUser._id.equals(listing.owner._id)) {%>
        <div class="action-buttons">
          <a href="/listings/<%= listing.id %>/edit" class="btn btn-outline-airbnb">
            <i class="fa-solid fa-edit"></i> Edit listing
          </a>
          <form method="POST" action="/listings/<%= listing.id %>?_method=DELETE" style="display: inline;" 
                onsubmit="return confirm('Are you sure you want to delete this listing?');">
            <button class="btn btn-outline-danger" style="padding: 8px 16px; border-radius: 8px;">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
          </form>
        </div>
      <% } %>
    </div>

    <!-- Image Gallery -->
    <div class="image-gallery">
      <img src="<%= listing.image.url %>" class="main-image" alt="<%= listing.title %>">
    </div>

    <!-- Listing Details -->
    <div class="listing-details">
      <div class="listing-info">
        <h2>Entire place hosted by <%= listing.owner.username %></h2>
        <div class="host-info">
          <i class="fa-solid fa-user"></i> Hosted by <%= listing.owner.username %>
        </div>
        
        <div class="amenities">
          <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">About this place</h3>
          <p style="line-height: 1.6; color: var(--airbnb-dark);"><%= listing.description %></p>
        </div>

        <!-- Map -->
        <div style="margin: 32px 0;">
          <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Where you'll be</h3>
          <div id="map" class="map-container" style="height: 400px; border-radius: 12px; overflow: hidden;"></div>
          <p style="margin-top: 8px; color: var(--airbnb-gray);"><%= listing.location %>, <%= listing.country %></p>
        </div>
      </div>

      <!-- Booking Card -->
      <div class="booking-card">
        <div class="price-display">
          ₹<%= new Intl.NumberFormat("en-IN").format(listing.price) %> <span style="font-size: 16px; font-weight: 400;">night</span>
        </div>
        
        <div style="border: 1px solid #DDDDDD; border-radius: 8px; margin-bottom: 16px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr;">
            <div style="padding: 12px; border-right: 1px solid #DDDDDD;">
              <div style="font-size: 10px; font-weight: 600; text-transform: uppercase;">CHECK-IN</div>
              <div style="font-size: 14px;">Add date</div>
            </div>
            <div style="padding: 12px;">
              <div style="font-size: 10px; font-weight: 600; text-transform: uppercase;">CHECK-OUT</div>
              <div style="font-size: 14px;">Add date</div>
            </div>
          </div>
          <div style="padding: 12px; border-top: 1px solid #DDDDDD;">
            <div style="font-size: 10px; font-weight: 600; text-transform: uppercase;">GUESTS</div>
            <div style="font-size: 14px;">1 guest</div>
          </div>
        </div>
        
        <button class="btn btn-airbnb w-100 mb-3" style="padding: 14px;">Reserve</button>
        <div style="text-align: center; font-size: 14px; color: var(--airbnb-gray);">
          You won't be charged yet
        </div>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="reviews-section">
      <% if(currentUser) { %>
        <div style="background: white; border: 1px solid #DDDDDD; border-radius: 12px; padding: 24px; margin-bottom: 32px;">
          <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">Leave a review</h3>
          <form action="/listings/<%= listing.id %>/reviews" method="POST" novalidate class="needs-validation">
            <div class="mb-3">
              <label class="form-label" style="font-weight: 500;">Rating</label>
              <div class="star-rating" style="direction: ltr; margin: 8px 0;">
                <% for (let i = 1; i <= 5; i++) { %>
                  <input type="radio" id="star<%= i %>" name="review[rating]" value="<%= i %>" required style="display: none;">
                  <label for="star<%= i %>" style="font-size: 24px; color: #DDDDDD; cursor: pointer; transition: color 0.2s;">&#9733;</label>
                <% } %>
              </div>
            </div>
            <div class="mb-3">
              <label for="comment" class="form-label" style="font-weight: 500;">Tell us about your experience</label>
              <textarea name="review[comment]" id="comment" rows="4" class="form-control" 
                       style="border-radius: 8px; border: 1px solid #DDDDDD; padding: 12px;" 
                       placeholder="Share details about your stay..." required></textarea>
            </div>
            <button type="submit" class="btn btn-airbnb">Submit review</button>
          </form>
        </div>
      <% } else { %>
        <div style="text-align: center; padding: 32px; background: var(--airbnb-light-gray); border-radius: 12px; margin-bottom: 32px;">
          <i class="fa-solid fa-star" style="font-size: 48px; color: #DDDDDD; margin-bottom: 16px;"></i>
          <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Sign in to leave a review</h3>
          <p style="color: var(--airbnb-gray); margin-bottom: 16px;">Share your experience with other travelers</p>
          <a href="/login" class="btn btn-airbnb">Sign in</a>
        </div>
      <% } %>

      <% if (listing.review && listing.review.length > 0) { %>
        <div style="margin-bottom: 32px;">
          <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px;">
            <i class="fa-solid fa-star" style="color: #FFD700; margin-right: 8px;"></i>
            <%= listing.review.length %> review<%= listing.review.length !== 1 ? 's' : '' %>
          </h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
            <% for (let review of listing.review) { %>
              <div style="background: white; border: 1px solid #EBEBEB; border-radius: 12px; padding: 20px;">
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                  <div style="background: var(--airbnb-red); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: 600;">
                    <%= review.author.username.charAt(0).toUpperCase() %>
                  </div>
                  <div>
                    <h6 style="margin: 0; font-weight: 600; font-size: 14px;"><%= review.author.username %></h6>
                    <div style="color: #FFD700; font-size: 14px;">
                      <% for (let i = 0; i < review.rating; i++) { %>★<% } %>
                      <% for (let i = review.rating; i < 5; i++) { %>☆<% } %>
                    </div>
                  </div>
                </div>
                <p style="margin: 0; line-height: 1.5; color: var(--airbnb-dark);"><%= review.comment %></p>
                <% if (currentUser && currentUser._id.equals(review.author._id)) { %>
                  <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" 
                        style="margin-top: 12px;" onsubmit="return confirm('Are you sure you want to delete this review?');">
                    <button type="submit" style="background: none; border: none; color: var(--airbnb-gray); font-size: 12px; text-decoration: underline; cursor: pointer;">
                      Delete review
                    </button>
                  </form>
                <% } %>
              </div>
            <% } %>
          </div>
        </div>
      <% } else { %>
        <div style="text-align: center; padding: 48px; color: var(--airbnb-gray);">
          <i class="fa-regular fa-comment" style="font-size: 48px; margin-bottom: 16px;"></i>
          <h3 style="font-size: 18px; margin-bottom: 8px;">No reviews yet</h3>
          <p>Be the first to share your experience!</p>
        </div>
      <% } %>
    </div>
  </div>

  <script src="/map.js"></script>
  
  <script>
    // Star rating functionality
    document.querySelectorAll('.star-rating input').forEach((input, index) => {
      input.addEventListener('change', function() {
        const rating = parseInt(this.value);
        const labels = this.closest('.star-rating').querySelectorAll('label');
        labels.forEach((label, labelIndex) => {
          label.style.color = labelIndex < rating ? '#FFD700' : '#DDDDDD';
        });
      });
    });

    // Star rating hover effect
    document.querySelectorAll('.star-rating label').forEach((label, index) => {
      label.addEventListener('mouseenter', function() {
        const labels = this.closest('.star-rating').querySelectorAll('label');
        labels.forEach((l, i) => {
          l.style.color = i <= index ? '#FFD700' : '#DDDDDD';
        });
      });
      
      label.addEventListener('mouseleave', function() {
        const checkedInput = this.closest('.star-rating').querySelector('input:checked');
        const labels = this.closest('.star-rating').querySelectorAll('label');
        if (checkedInput) {
          const rating = parseInt(checkedInput.value);
          labels.forEach((l, i) => {
            l.style.color = i < rating ? '#FFD700' : '#DDDDDD';
          });
        } else {
          labels.forEach(l => l.style.color = '#DDDDDD');
        }
      });
    });
  </script>
</body>